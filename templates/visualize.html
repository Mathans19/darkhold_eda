{% extends 'base.html' %}

{% block title %}Visual Reality: {{ dataset.name }} | Scarlet EDA{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://unpkg.com/@sgratzl/chartjs-chart-boxplot@3.6.0/build/index.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.1.1/dist/chartjs-chart-matrix.min.js"></script>
<style>
    .option-btn {
        transition: all 0.3s ease;
    }

    .option-btn.active {
        background-color: transparent;
        border-color: var(--color-scarlet);
        color: var(--color-scarlet);
        box-shadow: 0 0 15px rgba(255, 41, 66, 0.4);
    }

    .option-btn:hover:not(.active) {
        border-color: rgba(255, 41, 66, 0.5);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-140px)] animate__animated animate__fadeIn">

    <!-- Control Panel -->
    <div
        class="lg:col-span-4 glass-dark p-6 rounded-xl flex flex-col gap-8 overflow-y-auto custom-scrollbar border border-white/5 shadow-void">
        <h2 class="text-xl font-bold text-white flex items-center gap-3 font-cinzel border-b border-white/10 pb-4">
            <i class="fa-solid fa-compass-drafting text-scarlet animate-pulse"></i>
            Reality Builder
        </h2>

        <!-- Chart Type -->
        <div class="space-y-3">
            <label class="text-xs uppercase text-gray-500 font-bold tracking-[0.2em] block">Manifestation Form</label>
            <div class="grid grid-cols-4 gap-3">
                <button onclick="selectType('bar', this)"
                    class="option-btn active p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Bar">
                    <i class="fa-solid fa-chart-bar text-xl"></i>
                </button>
                <button onclick="selectType('line', this)"
                    class="option-btn p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Line">
                    <i class="fa-solid fa-chart-line text-xl"></i>
                </button>
                <button onclick="selectType('scatter', this)"
                    class="option-btn p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Scatter">
                    <i class="fa-solid fa-braille text-xl"></i>
                </button>
                <button onclick="selectType('pie', this)"
                    class="option-btn p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Pie">
                    <i class="fa-solid fa-chart-pie text-xl"></i>
                </button>
                <button onclick="selectType('histogram', this)"
                    class="option-btn p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Histogram">
                    <i class="fa-solid fa-chart-column text-xl"></i>
                </button>
                <button onclick="selectType('boxplot', this)"
                    class="option-btn p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Box Plot">
                    <i class="fa-solid fa-box text-xl"></i>
                </button>
                <button onclick="selectType('countplot', this)"
                    class="option-btn p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Count Plot">
                    <i class="fa-solid fa-chart-simple text-xl"></i>
                </button>
                <button onclick="selectType('correlation', this)"
                    class="option-btn p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Correlation Heatmap">
                    <i class="fa-solid fa-table-cells text-xl"></i>
                </button>
                <button onclick="selectType('missing', this)"
                    class="option-btn p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Missing Values">
                    <i class="fa-solid fa-eraser text-xl"></i>
                </button>
                <button onclick="selectType('grouped_bar', this)"
                    class="option-btn p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Grouped Bar">
                    <i class="fa-solid fa-layer-group text-xl"></i>
                </button>
                <button onclick="selectType('violin', this)"
                    class="option-btn p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Violin Plot">
                    <i class="fa-solid fa-music text-xl"></i>
                </button>
                <button onclick="selectType('pairplot', this)"
                    class="option-btn p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Pairwise Scatter">
                    <i class="fa-solid fa-circle-nodes text-xl"></i>
                </button>
                <button onclick="selectType('timeseries', this)"
                    class="option-btn p-3 rounded bg-black/40 border border-white/10 flex justify-center text-gray-400"
                    title="Time Series">
                    <i class="fa-solid fa-clock text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Axes Selection -->
        <div class="space-y-6">
            <div>
                <label class="text-xs uppercase text-gray-500 font-bold tracking-[0.2em] mb-2 block">X-Axis (Chaos
                    Dimension)</label>
                <div class="relative">
                    <select id="x-axis"
                        class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white focus:border-scarlet outline-none font-inter appearance-none">
                        <option value="">Select Dimension...</option>
                        {% for col in columns %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-gray-500 pointer-events-none"></i>
                </div>
            </div>

            <div id="y-axis-group">
                <label class="text-xs uppercase text-gray-500 font-bold tracking-[0.2em] mb-2 block">Y-Axis (Order
                    Dimension)</label>
                <div class="relative">
                    <select id="y-axis"
                        class="w-full bg-black/50 border border-gray-700 rounded p-3 text-white focus:border-scarlet outline-none font-inter appearance-none">
                        <option value="">Select Dimension...</option>
                        {% for col in numerical_cols %}<option value="{{ col }}">{{ col }}</option>{% endfor %}
                    </select>
                    <i class="fa-solid fa-chevron-down absolute right-3 top-3.5 text-gray-500 pointer-events-none"></i>
                </div>
            </div>
        </div>

        <!-- Action -->
        <button onclick="renderChart()"
            class="btn-energy w-full flex items-center justify-center gap-2 font-bold py-4 text-base tracking-widest">
            <i class="fa-solid fa-bolt"></i> Manifest Visualization
        </button>

        <!-- Export Button -->
        <button onclick="exportChart()" id="export-btn"
            class="mt-3 w-full bg-black/50 border border-gray-700 hover:border-scarlet text-white px-4 py-3 rounded flex items-center justify-center gap-2 font-bold text-sm tracking-widest transition-all disabled:opacity-30 disabled:cursor-not-allowed"
            disabled>
            <i class="fa-solid fa-download"></i> Export Chart (PNG)
        </button>
    </div>

    <!-- Chart Display -->
    <div
        class="lg:col-span-8 glass-dark p-6 rounded-xl relative flex items-center justify-center animate__animated animate__fadeInRight border border-white/5 shadow-void">

        <!-- Magic Corner Accents -->
        <div class="absolute top-0 right-0 w-16 h-16 border-t-2 border-r-2 border-scarlet/30 rounded-tr-xl"></div>
        <div class="absolute bottom-0 left-0 w-16 h-16 border-b-2 border-l-2 border-scarlet/30 rounded-bl-xl"></div>

        <!-- Placeholder/Loading -->
        <div id="chart-placeholder" class="text-center space-y-6">
            <div
                class="w-24 h-24 rounded-full border border-scarlet/20 flex items-center justify-center mx-auto relative">
                <div class="absolute inset-0 rounded-full border-t-2 border-scarlet animate-spin"></div>
                <i class="fa-solid fa-chart-area text-4xl text-scarlet/50"></i>
            </div>
            <div>
                <h3 class="text-xl font-cinzel text-white mb-2">Void Canvas</h3>
                <p class="text-gray-500 tracking-wider font-inter text-sm">Select dimensions to collapse the wave
                    function.</p>
            </div>
        </div>

        <canvas id="canvas" class="hidden w-full h-full p-4"></canvas>
    </div>
</div>

<script>
    let currentChart = null;
    let chartType = 'bar';

    // Chart.js Global Defaults
    Chart.defaults.color = '#a0a0a0';
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';

    function selectType(type, btn) {
        chartType = type;

        // UI Update
        document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Logic
        const yAxisGroup = document.getElementById('y-axis-group');
        // Charts that don't need Y-axis selection
        const noYAxisTypes = ['histogram', 'pie', 'countplot', 'boxplot', 'violin', 'missing', 'correlation'];

        if (noYAxisTypes.includes(type)) {
            yAxisGroup.style.display = 'none';
        } else {
            yAxisGroup.style.display = 'block';
        }
    }

    async function renderChart() {
        const xVal = document.getElementById('x-axis').value;
        const yVal = document.getElementById('y-axis').value;

        // Validation based on chart type
        const singleAxisTypes = ['histogram', 'pie', 'countplot', 'boxplot', 'violin', 'missing'];

        if (chartType === 'correlation') {
            // Correlation needs no axes inputs
        } else if (singleAxisTypes.includes(chartType)) {
            if (chartType !== 'missing' && !xVal) {
                alert("Define the primary dimension (X-Axis).");
                return;
            }
        } else {
            if (!xVal || !yVal) {
                alert("Define both Chaos (X) and Order (Y) dimensions.");
                return;
            }
        }

        const btn = document.querySelector('button[onclick="renderChart()"]');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Materializing...';
        btn.disabled = true;

        try {
            const response = await fetch(`?type=${chartType}&x=${xVal}&y=${yVal}`, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            // Destroy old chart
            if (currentChart) currentChart.destroy();

            // Hide placeholder, show canvas and enable export
            document.getElementById('chart-placeholder').classList.add('hidden');
            const canvas = document.getElementById('canvas');
            canvas.classList.remove('hidden');
            document.getElementById('export-btn').disabled = false;

            const ctx = canvas.getContext('2d');

            // Scarlet Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(255, 41, 66, 0.6)');
            gradient.addColorStop(1, 'rgba(255, 41, 66, 0.05)');

            let config = {
                type: 'bar',
                data: {},
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e0e0e0', font: { family: 'Cinzel', size: 12 } } },
                        tooltip: {
                            backgroundColor: 'rgba(5, 1, 2, 0.9)',
                            titleColor: '#ff2942',
                            titleFont: { family: 'Cinzel' },
                            bodyColor: '#fff',
                            borderColor: 'rgba(255, 41, 66, 0.3)',
                            borderWidth: 1,
                            padding: 10
                        }
                    },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#9ca3af' } },
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#9ca3af' } }
                    }
                }
            };

            // --- CHART SPECIFIC CONFIGS ---

            if (chartType === 'bar' || chartType === 'line' || chartType === 'scatter' || chartType === 'count') {
                config.type = chartType === 'count' ? 'bar' : chartType;
                config.data = {
                    labels: data.labels,
                    datasets: [{
                        label: yVal || 'Count',
                        data: data.values,
                        backgroundColor: chartType === 'line' ? 'transparent' : gradient,
                        borderColor: '#ff2942',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                };
            }
            else if (chartType === 'pie') {
                config.type = 'pie';
                config.data = {
                    labels: data.labels,
                    datasets: [{
                        data: data.values,
                        backgroundColor: [
                            'rgba(255, 41, 66, 0.8)', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6',
                            '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#a855f7'
                        ],
                        borderColor: '#000',
                        borderWidth: 2
                    }]
                };
            }
            else if (chartType === 'histogram') {
                config.type = 'bar';
                config.data = {
                    labels: data.labels,
                    datasets: [{
                        label: 'Frequency',
                        data: data.values,
                        backgroundColor: gradient,
                        borderColor: '#ff2942',
                        borderWidth: 1,
                        barPercentage: 1.0,
                        categoryPercentage: 1.0
                    }]
                };
            }
            else if (chartType === 'boxplot') {
                config.type = 'boxplot';
                config.data = {
                    labels: [data.label],
                    datasets: [{
                        label: xVal,
                        data: [[data.min, data.q1, data.median, data.q3, data.max]],
                        backgroundColor: 'rgba(255, 41, 66, 0.4)',
                        borderColor: '#ff2942',
                        borderWidth: 2,
                        outlierColor: '#fff',
                        itemRadius: 3
                    }]
                };
            }
            else if (chartType === 'correlation') {
                config.type = 'matrix';
                config.data = {
                    datasets: [{
                        label: 'Correlation',
                        data: data.data.map((row, i) => row.map((val, j) => ({ x: data.labels[i], y: data.labels[j], v: val }))).flat(),
                        backgroundColor: (ctx) => {
                            const val = ctx.raw.v;
                            const alpha = Math.abs(val);
                            return val > 0 ? `rgba(255, 41, 66, ${alpha})` : `rgba(59, 130, 246, ${alpha})`;
                        },
                        width: ({ chart }) => (chart.chartArea || {}).width / data.labels.length - 1,
                        height: ({ chart }) => (chart.chartArea || {}).height / data.labels.length - 1
                    }]
                };
                config.options.scales = {
                    x: { type: 'category', labels: data.labels, grid: { display: false } },
                    y: { type: 'category', labels: data.labels, grid: { display: false } }
                };
                config.options.plugins.tooltip.callbacks = {
                    title: () => '',
                    label: (context) => `${context.raw.x} x ${context.raw.y}: ${context.raw.v.toFixed(2)}`
                };
            }
            else if (chartType === 'missing') {
                config.type = 'bar';
                config.data = {
                    labels: data.labels,
                    datasets: [{
                        label: 'Missing Values',
                        data: data.values,
                        backgroundColor: 'rgba(255,99,132,0.6)',
                        borderColor: 'rgba(255,99,132,1)',
                        borderWidth: 1
                    }]
                };
                config.options.indexAxis = 'y'; // Horizontal bar
            }
            else if (chartType === 'timeseries') {
                config.type = 'line';
                config.data = {
                    labels: data.labels,
                    datasets: [{
                        label: yVal,
                        data: data.values,
                        borderColor: '#ff2942',
                        backgroundColor: 'rgba(255, 41, 66, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0
                    }]
                };
                config.options.scales.x = {
                    type: 'time',
                    time: { unit: 'day' },
                    grid: { color: 'rgba(255,255,255,0.05)' },
                    ticks: { color: '#9ca3af' }
                };
            }
            else if (chartType === 'grouped_bar') {
                config.type = 'bar';
                config.data = data; // data structure is already set in views.py
                // Add colors
                const colors = ['#ff2942', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'];
                config.data.datasets.forEach((ds, i) => {
                    ds.backgroundColor = colors[i % colors.length];
                });
            }
            else if (chartType === 'violin') {
                // Approximating Violin with BoxPlot capability or just disabling for now as strict violin is hard
                // Using Bar/Histogram representation of distribution
                config.type = 'bar';

                // Correcting labels for JS: formatting bins to 2 decimal places
                const formattedLabels = data.bins.slice(0, -1).map(b => b.toFixed(2));

                config.data = {
                    labels: formattedLabels, // Simulating
                    datasets: [{
                        label: 'Distribution Shape',
                        data: data.distribution,
                        backgroundColor: gradient,
                        tension: 0.4
                    }]
                };
                // NOTE: True violin plots are complex in Chart.js. Using dist histogram for now.
            }
            else if (chartType === 'pairplot') {
                config.type = 'scatter';
                config.data = {
                    datasets: [{
                        label: `${data.labels[0]} vs ${data.labels[1]}`,
                        data: data.x.map((x, i) => ({ x: x, y: data.y[i] })),
                        backgroundColor: '#ff2942'
                    }]
                };
                config.options.scales = {
                    x: { title: { display: true, text: data.labels[0], color: '#fff' } },
                    y: { title: { display: true, text: data.labels[1], color: '#fff' } }
                };
            }

            // Render
            currentChart = new Chart(ctx, config);

        } catch (e) {
            alert("Visualization Collapse: " + e.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function exportChart() {
        const canvas = document.getElementById('canvas');
        if (!currentChart) return;

        // Create link
        const link = document.createElement('a');
        link.download = `scarlet_insight_${chartType}_${new Date().getTime()}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    }
</script>
{% endblock %}